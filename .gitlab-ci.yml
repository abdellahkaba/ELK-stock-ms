stages:
  - packaging
  - build_docker_image

default:
  image: maven:3.8.3-openjdk-17

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  IMAGE_TAG: "$CI_REGISTRY/isi-dev/microservices/stock-ms:latest"

run unit tests and package:
  inherit:
    default: true
    variables: true
  stage: packaging
  script:
    - mvn clean package
  artifacts:
    paths:
      - target/*.jar
      #- target/surefire-reports
  cache:
    paths:
      - .m2/repository

# Build docker image form Docker compose
build docker image:
  image: docker:latest
  stage: build_docker_image
  services:
    - docker:dind
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $IMAGE_TAG .
    - docker push $IMAGE_TAG
    - echo "Image build"
  artifacts:
    paths:
      - stock-ms.tar
  when: manual
